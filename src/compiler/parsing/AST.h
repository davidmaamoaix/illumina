#ifndef ILLUMINA_AST_H
#define ILLUMINA_AST_H

#include <glib.h>
#include <stdbool.h>

#include "common/util/generic_structs.h"
#include "compiler/parsing/generated/Absyn.h"
#include "compiler/parsing/op_lit.h"

/*
 * Due to rapid changes in the frontend of the compiler,
 * a separate syntax tree is constructed independent of
 * the one generated by yacc. Also does not preliminary
 * processing.
 */

#define ATTR_HEADER uint16_t attrs;

#define AST_TRANS_DECL(header) program_t *(header)

typedef struct program_t {

    enum {
        PROGRAM, IMPORT,
        T_SIMP, T_COMP,
        TARG_SIMP, TARG_COVAR, TARG_CONTRA,
        TARG_DECL,

        LIT_TUP, LIT_LAM, LIT_INT, LIT_CHR,
        LIT_STR, LIT_LST, LIT_NUL, LIT_FLO,

        EXP_BIN, EXP_UN, EXP_VAR, EXP_FUNC, EXP_LIT,

        STMT_IFE, STMT_WHL, STMT_FOR, STMT_ASN,
        STMT_EXP, STMT_VAR, STMT_BRK, STMT_CON,
        STMT_RET, STMT_RTE,

        DECL_FUNC, DECL_GVAR, DECL_CLASS
    } kind;

    union {
        struct {
            GArray *imports; // <program_t>
            GArray *classes; // <program_t>
            GArray *funcs; // <program_t>
            GArray *vars;
        } program;

        struct {
            uint32_t attrs;
            GArray *pkgs; // <string>
        } import;

        struct {
            bool nullable;
            char *iden;
        } type_simp;

        struct {
            char *iden;
            GArray *params;
        } type_comp;

        char *targ_simp;

        struct {
            char *iden;
            struct program_t *type_node;
        } targ_comp;

        char *decl_targ;

        struct {
            struct program_t *type;
            char *iden;
        } var_sig;

        GArray *lit_tup; // <program_t>

        struct {
            GArray *params; // <string>
            GArray *stmts; // <program_t>
        } lit_lam;

        uint64_t lit_int;

        gunichar lit_chr;

        char *lit_str;

        GArray *lit_lst; // <program_t>

        uint64_t lit_flo;

        char *exp_var;

        struct {
            struct program_t *a;
            char *op;
            struct program_t *b;
        } exp_binop;

        struct {
            char *op;
            struct program_t *value;
        } exp_unop;

        struct {
            char *iden;
            GArray *type_params; // <program_t>
            GArray *params; // <program_t>
        } exp_call;

        struct program_t *exp_lit;

        struct {
            struct program_t *cond;
            GArray *if_stmt; // <program_t>
            GArray *else_stmt; // <program_t>
        } stmt_ife;

        struct {
            struct program_t *cond;
            GArray *stmt; // <program_t>
        } stmt_whl;

        struct {
            char *var;
            struct program_t *iter;
            GArray *stmt; // <program_t>
        } stmt_for;

        struct {
            struct program_t *var;
            op_t op;
            struct program_t *exp;
        } stmt_asn;

        struct program_t *stmt_exp;

        struct {
            GArray *defs; // <program_t>
        } var_def;

        struct program_t *stmt_ret;

        struct {
            char *iden;
            struct program_t *ret_type;
            GArray *param_sig; // <program_t>
            GArray *generic; // <program_t>
        } decl_func;

        struct {
            struct program_t *sig;
            char *iden;
            struct program_t *exp;
            bool initized;
        } decl_var;

        struct {
            uint32_t attrs;
            char *iden;
            GArray *targs; // <program_t>
            GArray *vars; // <program_t>
            GArray *funcs; // <program_t>

        } decl_class;
    } val;

} program_t;

void ast_free_node(program_t *);

AST_TRANS_DECL(gen_ast(Program));
AST_TRANS_DECL(gen_exp(Exp));
AST_TRANS_DECL(gen_import(ImportDecl));

#endif //ILLUMINA_AST_H
